name: ä¾å­˜é–¢ä¿‚ç›£è¦–

on:
  schedule:
    # æ¯æ—¥åˆå‰ 9 æ™‚ (JST) ã«å®Ÿè¡Œ
    - cron: '0 0 * * *'
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œå¯èƒ½

jobs:
  dependency-report:
    name: ğŸ“‹ ä¾å­˜é–¢ä¿‚ãƒ¬ãƒãƒ¼ãƒˆ
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        
      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'pnpm'
          
      - name: ğŸ“¦ Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8
          
      - name: ğŸ“¦ Install dependencies
        run: pnpm install --frozen-lockfile
        
      - name: ğŸ“‹ Generate comprehensive report
        run: |
          echo "# ğŸ“Š ä¾å­˜é–¢ä¿‚ç›£è¦–ãƒ¬ãƒãƒ¼ãƒˆ" > dependency-monitor-report.md
          echo "**ç”Ÿæˆæ—¥æ™‚**: $(date)" >> dependency-monitor-report.md
          echo "" >> dependency-monitor-report.md
          
          echo "## ğŸ”„ å¾ªç’°ä¾å­˜ãƒã‚§ãƒƒã‚¯" >> dependency-monitor-report.md
          if pnpm deps:check > /dev/null 2>&1; then
            echo "âœ… å¾ªç’°ä¾å­˜ãªã—" >> dependency-monitor-report.md
          else
            echo "âŒ å¾ªç’°ä¾å­˜ã‚ã‚Š" >> dependency-monitor-report.md
            echo '```' >> dependency-monitor-report.md
            pnpm deps:check >> dependency-monitor-report.md 2>&1 || true
            echo '```' >> dependency-monitor-report.md
          fi
          echo "" >> dependency-monitor-report.md
          
          echo "## ğŸ•¸ï¸ ä¾å­˜é–¢ä¿‚æ¤œè¨¼" >> dependency-monitor-report.md
          if pnpm deps:cruise > /dev/null 2>&1; then
            echo "âœ… ä¾å­˜é–¢ä¿‚æ¤œè¨¼å®Œäº†" >> dependency-monitor-report.md
          else
            echo "âš ï¸ ä¾å­˜é–¢ä¿‚ã«å•é¡Œã‚ã‚Š" >> dependency-monitor-report.md
          fi
          echo "" >> dependency-monitor-report.md
          
          echo "## ğŸ“Š é‡è¤‡ä¾å­˜" >> dependency-monitor-report.md
          duplicates=$(pnpm analyze:deps:duplicates)
          if [ -z "$duplicates" ]; then
            echo "âœ… é‡è¤‡ä¾å­˜ãªã—" >> dependency-monitor-report.md
          else
            echo "âš ï¸ é‡è¤‡ä¾å­˜ã‚ã‚Š:" >> dependency-monitor-report.md
            echo '```' >> dependency-monitor-report.md
            echo "$duplicates" >> dependency-monitor-report.md
            echo '```' >> dependency-monitor-report.md
          fi
          echo "" >> dependency-monitor-report.md
          
          echo "## ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»" >> dependency-monitor-report.md
          if pnpm security:audit > /dev/null 2>&1; then
            echo "âœ… ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è„†å¼±æ€§ãªã—" >> dependency-monitor-report.md
          else
            echo "âš ï¸ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è„†å¼±æ€§ã‚ã‚Š" >> dependency-monitor-report.md
            echo '```' >> dependency-monitor-report.md
            pnpm security:audit >> dependency-monitor-report.md 2>&1 || true
            echo '```' >> dependency-monitor-report.md
          fi
          echo "" >> dependency-monitor-report.md
          
          echo "## ğŸ“¦ ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸æƒ…å ±" >> dependency-monitor-report.md
          echo '```' >> dependency-monitor-report.md
          pnpm list --depth=0 >> dependency-monitor-report.md
          echo '```' >> dependency-monitor-report.md
          echo "" >> dependency-monitor-report.md
          
          echo "## ğŸ“Š ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ¡ãƒˆãƒªã‚¯ã‚¹" >> dependency-monitor-report.md
          echo "- **ç·ãƒ•ã‚¡ã‚¤ãƒ«æ•°**: $(find apps packages -name "*.ts" -o -name "*.tsx" | grep -v node_modules | wc -l | xargs)" >> dependency-monitor-report.md
          echo "- **ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸æ•°**: 4 (client, server, shared, ui)" >> dependency-monitor-report.md
          echo "- **ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£**: ãƒ¢ãƒãƒ¬ãƒ (pnpm workspace)" >> dependency-monitor-report.md
          echo "- **æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯**: TypeScript, React, Express, Prisma" >> dependency-monitor-report.md
          
        continue-on-error: true
        
      - name: ğŸ“¤ Upload report
        uses: actions/upload-artifact@v4
        with:
          name: dependency-monitor-report-$(date +%Y%m%d)
          path: dependency-monitor-report.md
          retention-days: 30
        continue-on-error: true
        
      - name: ğŸš¨ Create issue on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const title = 'ğŸš¨ ä¾å­˜é–¢ä¿‚ç›£è¦–: å•é¡Œã‚’æ¤œå‡º';
            const body = `
            ## ğŸš¨ ä¾å­˜é–¢ä¿‚ç›£è¦–ã§å•é¡ŒãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ
            
            **æ¤œå‡ºæ—¥æ™‚**: ${new Date().toISOString()}
            **ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼**: [${context.workflow}](${context.payload.repository.html_url}/actions/runs/${context.runId})
            
            ### ğŸ” ç¢ºèªãŒå¿…è¦ãªé …ç›®
            - å¾ªç’°ä¾å­˜ã®ç™ºç”Ÿ
            - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è„†å¼±æ€§ã®æ¤œå‡º
            - ä¾å­˜é–¢ä¿‚ã®æ•´åˆæ€§å•é¡Œ
            
            ### ğŸ› ï¸ å¯¾å‡¦æ–¹æ³•
            1. [ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ­ã‚°](${context.payload.repository.html_url}/actions/runs/${context.runId}) ã‚’ç¢ºèª
            2. å•é¡Œã®ã‚ã‚‹ä¾å­˜é–¢ä¿‚ã‚’ç‰¹å®š
            3. å¿…è¦ã«å¿œã˜ã¦ä¾å­˜é–¢ä¿‚ã‚’æ›´æ–°ã¾ãŸã¯ä¿®æ­£
            
            ### ğŸ“‹ é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
            - [ä¾å­˜é–¢ä¿‚åˆ†æãƒ¬ãƒãƒ¼ãƒˆ](${context.payload.repository.html_url}/actions/runs/${context.runId})
            - [CLAUDE.md](${context.payload.repository.html_url}/blob/main/CLAUDE.md)
            
            ã“ã® Issue ã¯ä¾å­˜é–¢ä¿‚ç›£è¦–ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã«ã‚ˆã£ã¦è‡ªå‹•ä½œæˆã•ã‚Œã¾ã—ãŸã€‚
            `;
            
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['dependencies', 'monitoring', 'automated']
            });
        continue-on-error: true