import { PrismaClient } from '@prisma/client'
import {
  SymbolRepository,
  CandleRepository,
  UserPreferencesRepository,
  ISymbolRepository,
  ICandleRepository,
  IUserPreferencesRepository,
} from '../repositories'

/**
 * å–å¼•ãƒ‡ãƒ¼ã‚¿ç”¨ã®ã‚³ã‚¢ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚µãƒ¼ãƒ“ã‚¹ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã§ã™ã€‚
 *
 * ã‚·ãƒ³ãƒœãƒ«ã€ãƒ­ãƒ¼ã‚½ã‚¯è¶³ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®šã®ãƒªãƒã‚¸ãƒˆãƒªã¸ã®ä¸€å…ƒã‚¢ã‚¯ã‚»ã‚¹ã‚’æä¾›ã—ã€
 * ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³æ”¯æ´ã¨ãƒ˜ãƒ«ã‚¹ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°æ©Ÿèƒ½ã‚’å«ã¿ã¾ã™ã€‚
 *
 * @generated by Claude ğŸ¤–
 */
export interface IDatabaseService {
  symbols: ISymbolRepository
  candles: ICandleRepository
  userPreferences: IUserPreferencesRepository
  startTransaction(): Promise<DatabaseTransaction>
  isHealthy(): Promise<boolean>
  cleanup(): Promise<void>
}

/**
 * ã‚¢ãƒˆãƒŸãƒƒã‚¯æ“ä½œç”¨ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ãƒ©ãƒƒãƒ‘ãƒ¼ã§ã™ã€‚
 *
 * ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆå†…ã§ã®ãƒªãƒã‚¸ãƒˆãƒªã‚¢ã‚¯ã‚»ã‚¹ã‚’æä¾›ã—ã€
 * ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ã®ãŸã‚ã®æ˜ç¤ºçš„ãªã‚³ãƒŸãƒƒãƒˆã¨ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯åˆ¶å¾¡ã‚’è¡Œã„ã¾ã™ã€‚
 *
 * @generated by Claude ğŸ¤–
 */
export interface DatabaseTransaction {
  symbols: ISymbolRepository
  candles: ICandleRepository
  userPreferences: IUserPreferencesRepository
  commit(): Promise<void>
  rollback(): Promise<void>
}

/**
 * å–å¼•ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ã®ãƒ¡ã‚¤ãƒ³ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚µãƒ¼ãƒ“ã‚¹ã‚¯ãƒ©ã‚¹ã§ã™ã€‚
 *
 * Prisma ORM ã‚’ä½¿ç”¨ã—ã¦ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ“ä½œã‚’æŠ½è±¡åŒ–ã—ã€ã‚·ãƒ³ãƒœãƒ«ã€ãƒ­ãƒ¼ã‚½ã‚¯è¶³ã€
 * ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®šã®å„ãƒªãƒã‚¸ãƒˆãƒªã¸ã®çµ±ä¸€ã‚¢ã‚¯ã‚»ã‚¹ã‚’æä¾›ã—ã¾ã™ã€‚
 *
 * @generated by Claude ğŸ¤–
 */
export class DatabaseService implements IDatabaseService {
  private prisma: PrismaClient
  public readonly symbols: ISymbolRepository
  public readonly candles: ICandleRepository
  public readonly userPreferences: IUserPreferencesRepository

  constructor(prisma?: PrismaClient) {
    this.prisma = prisma || new PrismaClient()
    this.symbols = new SymbolRepository(this.prisma)
    this.candles = new CandleRepository(this.prisma)
    this.userPreferences = new UserPreferencesRepository(this.prisma)
  }

  async startTransaction(): Promise<DatabaseTransaction> {
    return this.prisma.$transaction(async tx => {
      const transactionService = {
        symbols: new SymbolRepository(tx as PrismaClient),
        candles: new CandleRepository(tx as PrismaClient),
        userPreferences: new UserPreferencesRepository(tx as PrismaClient),
        commit: async () => {
          // Transaction is automatically committed when the function returns successfully
        },
        rollback: async () => {
          throw new Error('Transaction rollback requested')
        },
      }
      return transactionService
    })
  }

  async isHealthy(): Promise<boolean> {
    try {
      await this.prisma.$queryRaw`SELECT 1`
      return true
    } catch (error) {
      console.error('Database health check failed:', error)
      return false
    }
  }

  async cleanup(): Promise<void> {
    await this.prisma.$disconnect()
  }
}

// Singleton instance
let databaseService: DatabaseService | null = null

/**
 * ã‚·ãƒ³ã‚°ãƒ«ãƒˆãƒ³ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚µãƒ¼ãƒ“ã‚¹ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’å–å¾—ã—ã¾ã™ã€‚
 *
 * ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯æ–°ã—ãä½œæˆã—ã€æ—¢å­˜ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒã‚ã‚‹å ´åˆã¯
 * ãã‚Œã‚’è¿”ã—ã¾ã™ã€‚ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å…¨ä½“ã§å˜ä¸€ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šã‚’ç¶­æŒã—ã¾ã™ã€‚
 *
 * @returns {DatabaseService} ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚µãƒ¼ãƒ“ã‚¹ã®ã‚·ãƒ³ã‚°ãƒ«ãƒˆãƒ³ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹
 *
 * @generated by Claude ğŸ¤–
 */
export function getDatabaseService(): DatabaseService {
  if (!databaseService) {
    databaseService = new DatabaseService()
  }
  return databaseService
}

/**
 * ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚µãƒ¼ãƒ“ã‚¹ã®ã‚·ãƒ³ã‚°ãƒ«ãƒˆãƒ³ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã€‚
 *
 * ç¾åœ¨ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ null ã«è¨­å®šã—ã€æ¬¡å› getDatabaseService() å‘¼ã³å‡ºã—æ™‚ã«
 * æ–°ã—ã„ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒä½œæˆã•ã‚Œã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚ä¸»ã«ãƒ†ã‚¹ãƒˆç’°å¢ƒã§ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚
 *
 * @generated by Claude ğŸ¤–
 */
export function resetDatabaseService(): void {
  databaseService = null
}
